generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(cuid())
  email           String           @unique
  name            String
  phone           String           @unique
  cpf             String?          // CPF para Asaas
  role            UserRole         @default(CUSTOMER)
  
  // ========== Campos de Autenticação (Login Email+Senha) ==========
  passwordHash    String?          // Hash bcrypt da senha (nullable para migração de usuários antigos)
  isActive        Boolean          @default(true)  // false = conta bloqueada
  failedAttempts  Int              @default(0)     // Tentativas de login falhas consecutivas
  lockedUntil     DateTime?        // Bloqueio temporário por rate limit
  lastLoginAt     DateTime?        // Último login bem-sucedido
  emailVerifiedAt DateTime?        // Data de verificação do email (null = não verificado)
  
  // ========== Reset de Senha ==========
  resetToken       String?         // Token único para reset (hash SHA-256)
  resetTokenExpiry DateTime?       // Expiração do token (1 hora)
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  bookings        Booking[]
  credits         Credit[]
  subletRequests  SubletRequest[]
  packages        UserPackage[]
  magicLinkTokens MagicLinkToken[]
  emailActivationTokens EmailActivationToken[]
  refundRequests  RefundRequest[]  @relation("UserRefundRequests")
  reviewedRefunds RefundRequest[]  @relation("AdminReviewedRefunds")

  @@map("users")
}

model Room {
  id            String        @id @default(cuid())
  name          String
  slug          String        @unique
  description   String?
  imageUrl      String?
  capacity      Int           @default(2)
  amenities     String[]
  hourlyRate    Int           @default(0)
  pricePerHour  Int           @default(0)
  pricePackage4 Int           @default(0)
  pricePackage8 Int           @default(0)
  priceShift    Int           @default(0)
  tier          Int           @default(1) // 1=Consultório 1 (premium), 2=Consultório 2, 3=Consultório 3
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  bookings      Booking[]
  products      Product[]
  credits       Credit[]
  packages      UserPackage[]

  @@map("rooms")
}

model Booking {
  id              String         @id @default(cuid())
  roomId          String
  userId          String
  productId       String?
  startTime       DateTime
  endTime         DateTime
  status          BookingStatus  @default(PENDING)
  paymentId       String?
  paymentStatus   PaymentStatus  @default(PENDING)
  amountPaid      Int            @default(0)
  paymentMethod   String?
  bookingType     BookingType    @default(HOURLY)
  packageUsageId  String?
  isSublet        Boolean        @default(false)
  originalUserId  String?
  subletRequestId String?
  notes           String?
  // Campos para rastreamento de créditos
  creditsUsed     Int            @default(0)  // Valor em centavos consumido de créditos
  creditIds       String[]       // IDs dos créditos consumidos
  isManual        Boolean        @default(false) // Reserva criada manualmente pelo admin
  // Campos para controle financeiro
  origin          BookingOrigin  @default(COMMERCIAL) // Origem: comercial ou cortesia
  financialStatus FinancialStatus @default(PENDING_PAYMENT) // Status financeiro
  courtesyReason  String?        // Motivo da cortesia (obrigatório se origin = ADMIN_COURTESY)
  // Campo para controle de envio de email
  emailSentAt     DateTime?      // Data/hora do envio do email de confirmação (evita duplicidade)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  product         Product?       @relation(fields: [productId], references: [id])
  room            Room           @relation(fields: [roomId], references: [id])
  subletRequest   SubletRequest? @relation(fields: [subletRequestId], references: [id])
  user            User           @relation(fields: [userId], references: [id])
  refundRequest   RefundRequest?

  @@index([roomId, startTime, endTime])
  @@index([userId])
  @@index([status])
  @@map("bookings")
}

model UserPackage {
  id             String        @id @default(cuid())
  userId         String
  roomId         String?       // Sala específica do pacote (null = genérico)
  type           PackageType
  totalHours     Int
  usedHours      Int           @default(0)
  remainingHours Int
  purchaseDate   DateTime      @default(now())
  expiresAt      DateTime
  paymentId      String?
  paymentStatus  PaymentStatus @default(PENDING)
  amountPaid     Int           @default(0)
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  user           User          @relation(fields: [userId], references: [id])
  room           Room?         @relation(fields: [roomId], references: [id])

  @@index([userId, expiresAt])
  @@index([roomId])
  @@map("user_packages")
}

model Credit {
  id              String         @id @default(cuid())
  userId          String
  roomId          String?        // Sala específica do crédito (determina hierarquia)
  amount          Int            // Valor em centavos
  remainingAmount Int            @default(0) // Valor restante (para uso parcial)
  type            CreditType
  status          CreditStatus   @default(PENDING)
  subletRequestId String?
  sourceBookingId String?        // Booking que originou o crédito (cancelamento)
  referenceMonth  Int
  referenceYear   Int
  expiresAt       DateTime?
  usedAt          DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  subletRequest   SubletRequest? @relation(fields: [subletRequestId], references: [id])
  user            User           @relation(fields: [userId], references: [id])
  room            Room?          @relation(fields: [roomId], references: [id])

  @@index([userId, status])
  @@index([roomId])
  @@map("credits")
}

model SubletRequest {
  id          String       @id @default(cuid())
  userId      String
  date        DateTime
  shiftType   ShiftType
  status      SubletStatus @default(PENDING)
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  bookings    Booking[]
  credits     Credit[]
  user        User         @relation(fields: [userId], references: [id])

  @@index([userId, status])
  @@map("sublet_requests")
}

model Product {
  id            String      @id @default(cuid())
  name          String
  slug          String      @unique
  description   String?
  type          ProductType
  price         Int
  originalPrice Int?
  hoursIncluded Int?
  validityDays  Int?
  shiftType     ShiftType?
  roomId        String?
  isActive      Boolean     @default(true)
  isFeatured    Boolean     @default(false)
  sortOrder     Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  bookings      Booking[]
  room          Room?       @relation(fields: [roomId], references: [id])

  @@index([roomId])
  @@map("products")
}

model Payment {
  id          String        @id @default(cuid())
  bookingId   String?
  userId      String
  amount      Int
  status      PaymentStatus @default(PENDING)
  method      String?
  externalId  String?
  externalUrl String?
  paidAt      DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([externalId])
  @@map("payments")
}

// ===========================================================
// Magic Link Token - Autenticação do Cliente
// ===========================================================
model MagicLinkToken {
  id          String    @id @default(cuid())
  userId      String
  tokenHash   String    @unique  // SHA-256 do token (nunca salvar token raw)
  expiresAt   DateTime           // 12 horas após criação
  usedAt      DateTime?          // Quando foi usado (null = não usado)
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("magic_link_tokens")
}

// Rate limit para magic links (3 por hora por email)
model MagicLinkRateLimit {
  id        String   @id @default(cuid())
  email     String
  attempts  Int      @default(1)
  windowStart DateTime @default(now())
  
  @@unique([email])
  @@map("magic_link_rate_limits")
}

// ===========================================================
// Email Activation Token - Ativação de Conta (checkout anônimo)
// ===========================================================
model EmailActivationToken {
  id          String    @id @default(cuid())
  userId      String
  tokenHash   String    @unique  // SHA-256 do token + PEPPER (nunca salvar token raw)
  expiresAt   DateTime           // 12 horas após criação
  usedAt      DateTime?          // Quando foi usado (null = não usado)
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("email_activation_tokens")
}

// ===========================================================
// Webhook Event - Idempotência para webhooks Asaas
// ===========================================================
model WebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique  // ID do evento do Asaas
  eventType   String             // PAYMENT_RECEIVED, etc
  paymentId   String?            // ID do pagamento no Asaas
  bookingId   String?            // ID do booking relacionado
  status      String   @default("PROCESSED")  // PROCESSED, FAILED, SKIPPED
  payload     Json?              // Payload completo para debug
  processedAt DateTime @default(now())
  
  @@index([eventId])
  @@index([paymentId])
  @@index([processedAt])
  @@map("webhook_events")
}

model AuditLog {
  id         String      @id @default(uuid())
  action     AuditAction
  source     AuditSource
  actorId    String?
  actorEmail String?
  actorIp    String?
  userAgent  String?
  targetType String?
  targetId   String?
  metadata   Json?
  createdAt  DateTime    @default(now())

  @@index([action])
  @@index([source])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@index([actorEmail])
  @@map("audit_logs")
}

enum UserRole {
  CUSTOMER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  REFUNDED
  IN_PROCESS
}

enum BookingType {
  HOURLY
  PACKAGE
  SHIFT
  SUBLET
}

enum PackageType {
  HOURS_4
  HOURS_8
}

enum CreditType {
  SUBLET
  PROMO
  CANCELLATION  // Crédito gerado por cancelamento
  SATURDAY      // Crédito específico para sábado
  MANUAL        // Crédito criado manualmente pelo admin
}

enum CreditStatus {
  PENDING
  CONFIRMED
  USED
  EXPIRED
  REFUNDED
}

enum ShiftType {
  MORNING
  AFTERNOON
}

enum SubletStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum ProductType {
  HOURLY_RATE
  PACKAGE_10H
  PACKAGE_20H
  PACKAGE_40H
  SHIFT_FIXED
  DAY_PASS
  SATURDAY_HOUR
  SATURDAY_5H
  PROMO
}

enum AuditAction {
  BOOKING_CREATED
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  BOOKING_EXPIRED
  BOOKING_MANUAL_CREATED
  BOOKING_COURTESY_CREATED
  BOOKING_CANCELLED_AUTO
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  PAYMENT_BACKFILL
  CREDIT_CREATED
  CREDIT_USED
  CREDIT_EXPIRED
  CREDIT_REFUNDED
  ADMIN_LOGIN
  ADMIN_LOGOUT
  ADMIN_BOOKING_VIEW
  ADMIN_BOOKING_UPDATE
  ADMIN_BACKFILL_EXECUTED
  ALERT_PAYMENT_NOT_CONFIRMED
  USER_LOGIN
  USER_LOGIN_FAILED
  USER_LOGOUT
  USER_REGISTER
  USER_MAGIC_LINK_REQUESTED
  USER_MAGIC_LINK_RATE_LIMITED
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
  // Refund workflow
  REFUND_REQUESTED
  REFUND_REVIEWING
  REFUND_APPROVED
  REFUND_REJECTED
  REFUND_PAID
}

// Origem da reserva: comercial ou cortesia
enum BookingOrigin {
  COMMERCIAL
  ADMIN_COURTESY
}

// Status financeiro da reserva
enum FinancialStatus {
  PENDING_PAYMENT
  PAID
  COURTESY
}

enum AuditSource {
  USER
  ADMIN
  SYSTEM
}

// ===========================================================
// RefundRequest - Pedido de Estorno Manual
// ===========================================================
// Ticket para processamento manual de estornos
// Não automatiza PIX - apenas registra e controla workflow

model RefundRequest {
  id              String       @id @default(cuid())
  bookingId       String       @unique
  userId          String
  amount          Int          // Valor em centavos a devolver
  pixKeyType      PixKeyType
  pixKey          String       // Chave PIX do cliente
  status          RefundStatus @default(REQUESTED)
  reason          String?      // Motivo do pedido (opcional)
  reviewedBy      String?      // userId do admin que revisou
  reviewedAt      DateTime?    // Data da revisão
  reviewNotes     String?      // Notas internas do admin
  rejectionReason String?      // Motivo da rejeição (obrigatório se REJECTED)
  proofUrl        String?      // Link do comprovante de pagamento
  paidAt          DateTime?    // Data do pagamento efetivo
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  booking         Booking      @relation(fields: [bookingId], references: [id])
  user            User         @relation("UserRefundRequests", fields: [userId], references: [id])
  reviewer        User?        @relation("AdminReviewedRefunds", fields: [reviewedBy], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("refund_requests")
}

enum RefundStatus {
  REQUESTED   // Pedido feito pelo cliente
  REVIEWING   // Admin em análise
  APPROVED    // Aprovado, aguardando pagamento
  PAID        // Pago (estorno concluído)
  REJECTED    // Rejeitado pelo admin
}

enum PixKeyType {
  CPF
  CNPJ
  EMAIL
  PHONE
  RANDOM
}

model RateLimit {
  id          String   @id @default(cuid())
  key         String   @unique // formato: "action:identifier"
  requests    Int      @default(0)
  windowStart DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([windowStart])
  @@map("rate_limits")
}

// ===========================================================
// Settings - Configurações do sistema (Marketing, Integrações)
// ===========================================================
// Armazena configurações dinâmicas que não exigem rebuild
// Formato key-value com tipagem e metadata

model Setting {
  id          String   @id @default(cuid())
  key         String   @unique // ex: "META_PIXEL_ID", "GA_MEASUREMENT_ID"
  value       String   // Valor da configuração
  type        String   @default("string") // string, boolean, number, json
  category    String   @default("general") // general, marketing, integrations
  description String?  // Descrição para UI
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@map("settings")
}

// ===========================================================
// AuditEvent - Eventos de auditoria para observabilidade
// ===========================================================
// Registro de eventos críticos do sistema (best-effort)
// Usado para debugging, compliance e análise

model AuditEvent {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  requestId   String?  // Correlation ID do request
  type        String   // BOOKING_CREATED, PURCHASE_CREATED, PAYMENT_CONFIRMED, etc
  userId      String?  // ID do usuário (quando disponível)
  entityType  String   // Booking, Credit, Payment, etc
  entityId    String   // ID da entidade
  payloadJson Json?    // Dados adicionais (metadata)

  @@index([type])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_events")
}